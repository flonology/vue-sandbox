<script type="text/x-template" id="backup-tpl">
    <form autocomplete="off" v-on:submit.prevent="nothing">
        <fieldset>
            <legend>Backup</legend>

            <div class="backup__message">{{ backupMessage }}</div>

            <a
                class="backup__link"
                v-if="backupUrl"
                v-bind:href="backupUrl"
                v-on:click="resetBackupUrl">► download</a>

            <button
                class="button"
                type="button"
                v-on:click="gotoCreds">◀︎ back</button>
        </fieldset>

        <fieldset style="margin-top: 1.5em;">
            <legend>Restore</legend>

            <div class="backup__message">{{ restoreMessage }}</div>
            <input type="file" v-on:change="fileSelected" ref="fileToUpload"/>

            <button
                v-show="showRestoreButton"
                class="button"
                type="button"
                v-on:click="restoreBackup">restore</button>

            <button
                class="button"
                type="button"
                v-on:click="gotoCreds">◀︎ back</button>
        </fieldset>

        <fieldset style="margin-top: 1.5em;">
            <legend>Delete account</legend>

            <div>
                This deletes all your stored data.
                If you have a backup, you can re-register later and
                restore your creds from that file.
            </div>

            <button
                class="button"
                type="button"
                v-on:click="gotoCreds">◀︎ back</button>

            <button
                class="button"
                type="button"
                v-on:click="deleteAccount">delete account</button>
        </fieldset>
    </form>
</script>


<script>
    Vue.component('backup', {
        template: '#backup-tpl',
        props: ['api'],
        mounted: function() {
            this.fetchBackupUrl();
        },
        computed: {
            showRestoreButton: function() {
                return this.fileToUpload && !this.restoreInProgress
            }
        },
        data: function() {
            return {
                backupUrl: '',
                backupMessage: '',
                restoreMessage: 'Choose file to restore from',
                fileToUpload: null,
                restoreInProgress: false
            };
        },
        methods: {
            deleteAccount: function() {
                console.log('Delete account... (use timer thing?)');
            },
            fileSelected: function() {
                this.fileToUpload = this.$refs.fileToUpload.files[0];
                this.restoreMessage = 'Ready to restore…';
            },
            restoreBackup: function() {
                if (this.fileToUpload == null) {
                    return;
                }

                var self = this;
                var formData = new FormData();
                formData.append('backup_file', this.fileToUpload);

                self.restoreMessage = 'Uploading…';
                self.restoreInProgress = true;

                this.api.restoreBackup(formData, function(success) {
                    self.restoreMessage
                        = 'Nice. Restored ' + success.restored + ', '
                        + 'updated ' + success.updated + ', and left '
                        + success.untouched + ' untouched.';

                    /* todo: remove back button, show reload/apply button */
                    setTimeout(function() {
                        self.$emit('backup-restored');
                    }, 1000);
                }, function(error) {
                    self.restoreMessage = 'Error: ' + error.statusText;
                });
            },
            resetBackupUrl: function() {
                this.backupUrl = '';
            },
            fetchBackupUrl: function() {
                var self = this;
                self.backupMessage = 'Preparing…';

                self.api.getBackupUrl(function(url) {
                    self.backupUrl = url;
                    self.backupMessage = 'Ready';
                }, function(error) {
                    self.backupMessage = 'Error: ' + error.statusText;
                });
            },
            nothing: function() {
                return;
            },
            gotoCreds: function() {
                this.$emit('goto-creds');
            }
        }
    });
</script>
