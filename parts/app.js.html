<script>
    var app = new Vue({
        el: '#app',
        data: {
            page: 'login',
            api: My.Api(),
            encryptor: My.Encryptor(),
            credsEnc: [],
            credsDec: [],
            selectedListEntry: null,
            creatingEntry: false,
            highlightEntry: 0
        },
        mounted: function () {
            // This should happen after login on seperate page (component)
            this.encryptor.setPassword('Johns Encryption Phrase');
        },
        methods: {
            gotoList: function() {
                this.page = 'list';
            },
            logout: function() {
                this.page = 'login';
            },
            addEntry: function() {
              this.page = 'add';
            },
            getCreds: function() {
                var self = this;

                this.api.getCreds(function(creds) {
                    self.credsEnc = creds;
                    self.decryptCreds();
                }, function() {
                    // Go to error page here
                    // Logout (remove api key from api and password from encryptor)
                    // Go to login
                    console.log('Could not get credsâ€¦');
                });
            },
            decryptCreds: function() {
                this.credsDec = this.encryptor.decryptCreds(this.credsEnc);
                this.gotoList();
            },
            createEntry: function(entry) {
                var self = this;

                self.creatingEntry = true;
                var encrypted = this.encryptor.encrypt(JSON.stringify(entry));

                var successCall = function(createdId) {
                    var newEntry = {
                        id: createdId,
                        title: entry.title,
                        username: entry.username,
                        url: entry.url,
                        password: entry.password,
                        notes: entry.notes,
                        selected: false
                    };

                    self.credsDec.unshift(newEntry);
                    self.creatingEntry = false;
                    self.gotoList();

                    self.highlightEntry = createdId;
                    setTimeout(function() {
                        self.highlightEntry = 0;
                    }, 1500);
                }

                var errorCall = function() {
                    console.log('Oh nooooo....');
                    self.creatingEntry = false;
                }

                self.api.createCred(encrypted, successCall, errorCall);
            },
            showListEntry: function(selectedListEntry) {
                if (selectedListEntry == null) {
                    return;
                }

                this.selectedListEntry = selectedListEntry;
                this.page = 'entry';
            }
        }
    })
</script>
